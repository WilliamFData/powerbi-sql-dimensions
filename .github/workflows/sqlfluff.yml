name: SQL Auto-Fix

on:
  workflow_dispatch:
  push:
    paths:
      - '**/*.sql'
  pull_request:
    paths:
      - '**/*.sql'

permissions:
  contents: write  # Required to push changes back to the repo

jobs:
  fix-sql:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Ensure write permissions
        run: chmod -R 777 ${{ github.workspace }}

      - name: Run SQLFluff Fix and Save to New File
        run: |
          for file in $(find ${{ github.workspace }} -name "*.sql"); do
            filename=$(basename "$file")
            dirname=$(dirname "$file")
            newfile="${dirname}/${filename%.sql}.fixed.sql"

            docker run --rm \
              -v "${{ github.workspace }}:/code" \
              sqlfluff/sqlfluff:latest \
              fix "/code/${file#$GITHUB_WORKSPACE/}" --dialect snowflake --force \
              | tee "$newfile"
          done

      - name: Commit and Push Fixed Files
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add .
          git commit -m "Auto-generated SQL fixes via SQLFluff" || echo "No changes to commit"
          git push
